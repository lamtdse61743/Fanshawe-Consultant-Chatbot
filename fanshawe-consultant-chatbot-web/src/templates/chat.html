<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fanshawe Consultant Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .process-log {
            background: #f0fff0;
            color: #000000;
            font-size: 0.95em;
            border-left: 3px solid #2fd32f;
            margin: 10px 0 20px 0;
            padding: 10px 16px;
            border-radius: 8px;
            white-space: pre-wrap;
        }
        .bot-message {
            color: #1565c0;
        }
    </style>
</head>
<body>
    
    <div style="text-align:center; margin-top:30px;">
        <h2 style="font-size:1.2em; color:#444; margin:0;">
            INFO-6153 NLP FINAL PROJECT<br>
            <span style="font-size:1em; color:#666;">by William Ngo, Lam Dinh Trinh</span>
        </h2>
    </div>
    <div class="chat-container">
        <h1>Fanshawe Consultant Chatbot</h1>
        <div id="conversation" class="conversation">
            <!-- Conversation history will be displayed here -->
        </div>
        <input type="text" id="user-input" placeholder="Type your question here..." />
        <button id="send-button">Send</button>
    </div>

    <script>
    const sendButton = document.getElementById('send-button');
    const userInput = document.getElementById('user-input');
    const conversation = document.getElementById('conversation');

    function typeResponse(element, text, duration = 5000) {
        const lines = text.split('\n');
        const totalChars = text.length;
        let display = '';
        let start = Date.now();

        function type() {
            let elapsed = Date.now() - start;
            let percent = Math.min(elapsed / duration, 1);
            let charsToShow = Math.floor(percent * totalChars);

            // Build the string up to charsToShow, preserving line breaks
            let shown = 0;
            display = '';
            for (let line of lines) {
                if (shown + line.length < charsToShow) {
                    display += line + '<br>';
                    shown += line.length + 1; // +1 for the newline
                } else {
                    display += line.slice(0, charsToShow - shown);
                    break;
                }
            }
            element.innerHTML = `<span style="color:#1565c0;">Bot: ${display}</span>`;

            if (charsToShow < totalChars) {
                requestAnimationFrame(type);
            } else {
                element.innerHTML = `<span style="color:#1565c0;">Bot: ${text.replace(/\n/g, '<br>')}</span>`;
            }
        }
        type();
    }

    async function sendMessage() {
        const query = userInput.value;
        if (query.trim() === '') return;

        // Display user question
        conversation.innerHTML += `<div class="user-message">User: ${query}</div>`;
        userInput.value = '';

        // Show typing effect
        const typingId = `typing-${Date.now()}`;
        conversation.innerHTML += `<div class="bot-message" id="${typingId}"><em>Bot is typing...</em></div>`;
        conversation.scrollTop = conversation.scrollHeight;

        // Send the query to the server
        const response = await fetch('/ask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ query: query })
        });

        const data = await response.json();
        const answer = data.response;

        // Show process log in green first
        if (data.process_log) {
            conversation.innerHTML += `<div class="process-log"><pre>${data.process_log.join('\n')}</pre></div>`;
            conversation.scrollTop = conversation.scrollHeight;
        }

        // Then animate the bot's answer in blue
        typeResponse(document.getElementById(typingId), answer, 5000);
        conversation.scrollTop = conversation.scrollHeight;
    }

    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') sendMessage();
    });
    </script>
</body>